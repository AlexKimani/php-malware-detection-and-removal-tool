<?php
/*
 * PHP malware detection and removal tool
 * By Thameur Belghith
 * Copy it into the http directory containing infected files
 * and execute it from your favorite browser
 * Your suggestions will help making a better script, your donations also ;)
 */

session_start();
$malware = '';

if(isset($_POST['malware'])){
	$_SESSION['malware'] = $_POST['malware'];
	$malware = $_POST['malware'];
}
elseif(isset($_SESSION['malware']))
	$malware = $_SESSION['malware'];

function listdir($dir='.') { 
	if (!is_dir($dir))
		return false; 

	$files = array(); 
	listdiraux($dir, $files); 

	return $files; 
} 

function listdiraux($dir, &$files) { 
	$handle = opendir($dir); 
	while (($file = readdir($handle)) !== false) { 
		if ($file == '.' || $file == '..') { 
		continue; 
	} 
	$filepath = $dir == '.' ? $file : $dir . '/' . $file; 
	if (is_link($filepath) || !is_readable($filepath))
		continue; 
	// return mime type ala mimetype extension
	$finfo = finfo_open(FILEINFO_MIME);

	if (is_file($filepath) && substr(finfo_file($finfo, $filepath), 0, 4) == 'text') 
		$files[] = $filepath; 
	else if (is_dir($filepath)) 
		listdiraux($filepath, $files); 
	} 
	closedir($handle); 
}

function detect_malware(){
	$files = listdir('.'); 
	sort($files, SORT_LOCALE_STRING);
	foreach ($files as $file) {
		$rep =''; 
		if($file != basename(__FILE__) && is_readable($file)){ 
			$fh = fopen($file, 'r'); 
			$contents = fread($fh, filesize($file)); 
			fclose($fh);
			if (preg_match('/[\@]?eval\(base64_decode\([\"\']?[a-zA-F0-9\=\+\$](.*?)[\"\']?\)\);/', $contents, $matches) ||
				preg_match('/[\@]?eval\(gzinflate\(base64_decode\([\"\']?[a-zA-F0-9\=\+\$](.*?)[\"\']?\)\)\);/', $contents, $matches))
				return $matches[0];
		}
	}
}
?>

<?php if(isset($_GET['detect']) || !isset($_SERVER['HTTP_USER_AGENT'])) : ?>
<?php
$malware = detect_malware();
if(!isset($_SERVER['HTTP_USER_AGENT']))
	echo $malware . "\n";
?>
<?php endif; ?>


<?php if(isset($_SERVER['HTTP_USER_AGENT'])) : ?>
<hr>
<h1><b>PHP Malware detection and removal tool</b></h1>
<i>by: Thameur Belghith</i>
<br />
<table border='0'><tr>
<td>
<a name="freelancer_Hireme" user_id="2492611" size="standard" annotation="none" title="Hire me! on Freelancer.com" href="http://www.freelancer.com/users/2492611.html">Linux Developer</a><script type="text/javascript">(function() {var po = document.createElement("script");po.type = "text/javascript"; po.async = true;po.src = ("https:" == document.location.protocol ? "https" : "http") + "://www.freelancer.com/js/hireme/widget.js";var s = document.getElementsByTagName("script")[0];s.parentNode.insertBefore(po, s);})();</script>
</td>

<td>
<div align='right'>

<br>
<form action="https://www.paypal.com/cgi-bin/webscr" method="post">
<input type="hidden" name="cmd" value="_donations">
<input type="hidden" name="business" value="bilel.karoui@gmail.com">
<input type="hidden" name="lc" value="US">
<input type="hidden" name="item_name" value="Thameur Belghith">
<input type="hidden" name="no_note" value="0">
<input type="hidden" name="currency_code" value="USD">
<input type="hidden" name="bn" value="PP-DonationsBF:btn_donateCC_LG.gif:NonHostedGuest">
<input type="image" src="https://www.paypalobjects.com/en_US/i/btn/btn_donateCC_LG.gif" border="0" name="submit" alt="PayPal - The safer, easier way to pay online!">
<img alt="" border="0" src="https://www.paypalobjects.com/fr_XC/i/scr/pixel.gif" width="1" height="1">
</form>
</div>
</td>
</tr></table>

<hr>


<b>Malware String: </b>
<a href="<?php echo basename(__FILE__); ?>?detect=1">Detect it!</a>
<br>
<form method="post" enctype="multipart/form-data" action="<?php echo basename(__FILE__); ?>?scan=1">
   <textarea name="malware" rows="10" cols="120"><?php echo $malware; ?></textarea>
   <br>
   <input type=submit value="Scan files"/>
</form>

<hr>
<?php endif; ?>

<?php if($malware != "" && (isset($_GET['scan']) || isset($_GET['fix']) || !isset($_SERVER['HTTP_USER_AGENT']))) : ?>
<table border='0'>

<?php

$files = listdir('.'); 
sort($files, SORT_LOCALE_STRING); 

$scanned = count($files);
$infected = 0;
$fixed = 0;

foreach ($files as $file) {
	echo "<tr>";
	echo "<td><li>" . $file . "</td>";
	echo "<td>";
	$rep =''; 
	echo "<b><small>";
	if($file != basename(__FILE__)){ 
		if(is_readable($file)) {
			$fh = fopen($file, 'r'); 
			$contents = fread($fh, filesize($file)); 
			fclose($fh);
			$count = 0;
			$new_contents = str_replace($malware, $rep, $contents, $count);

			if($count > 0){
				$infected += 1;
				echo "<font color='red'>[Infected]</font> ";
				if(isset($_GET['fix']) || !isset($_SERVER['HTTP_USER_AGENT'])){
					if(is_writable($file)){
						$fh = fopen($file, 'w+'); 
						fwrite($fh, $new_contents); 
						fclose($fh);
						$fixed += 1;
						echo "<font color='blue'>[Fixed]</font>";
					}
					else
						echo "<font color='orange'>[Readonly]</font>";
				}
			}
			else
				echo "<font color='green'>[Clean]</font>";
		}
		else
			echo "<font color='orange'>[Access Denied]</font>";
		echo "</small></b></li>";
		echo "</td>";
		echo "</tr>";
	}
}

echo "</table>";

$fix_them_link = "";
if($infected > 0 && !isset($_GET['fix']))
	$fix_them_link = " [<a href='".basename(__FILE__)."?fix=1'>Fix them</a>]";


echo "<hr>";
echo "<h1><b>Summary:</b></h1>";
echo "<hr>";
echo "Scanned files : <b>" . $scanned . "</b><br>";
echo "Infected files : <b>" . $infected . " " . $fix_them_link . "</b><br>";
echo "Fixed files : <b>" . $fixed . "</b><br>";

?>

<?php endif; ?>
